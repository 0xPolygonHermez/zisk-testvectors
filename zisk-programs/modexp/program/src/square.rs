use ziskos::zisklib::{square_long, square_short, U256};

use super::constants::*;

pub fn square_tests() {
    // [5]
    let a = U256::from_u64(5);
    let (res, len_res) = square_short(&a);
    assert_eq!(len_res, 1);
    assert_eq!(&res[..len_res], [U256::from_u64(25)]);

    // [MAX]
    let a = U256::MAX;
    let (res, len_res) = square_short(&a);
    assert_eq!(len_res, 2);
    assert_eq!(res, [U256::ONE, U256_MAX_MINUS_ONE]);

    // [MAX, MAX]
    let a = [U256::MAX, U256::MAX];
    let mut res = [U256::ZERO; 4];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 4);
    assert_eq!(res, [U256::ONE, U256::ZERO, U256_MAX_MINUS_ONE, U256::MAX]);

    // [4n, 4n, 4n, 3n, 2n, 4n]
    let a = [
        U256::from_u64(4),
        U256::from_u64(4),
        U256::from_u64(4),
        U256::from_u64(3),
        U256::from_u64(2),
        U256::from_u64(4),
    ];
    let mut res = [U256::ZERO; 12];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 11);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64(16),
            U256::from_u64(32),
            U256::from_u64(48),
            U256::from_u64(56),
            U256::from_u64(56),
            U256::from_u64(72),
            U256::from_u64(57),
            U256::from_u64(44),
            U256::from_u64(28),
            U256::from_u64(16),
            U256::from_u64(16),
        ]
    );

    // [49625181101706940895816136432294817651401421999560241731196107431962769845690, 16541727033902313631938712144098272550467140666520080577065369143987589948564, 2]
    let a = [
        U256::from_u64s(&[
            7905747460161236410,
            13176245766935394011,
            15811494920322472813,
            7905747460161236406,
        ]),
        U256::from_u64s(&[
            2635249153387078804,
            10540996613548315209,
            5270498306774157604,
            2635249153387078802,
        ]),
        U256::from_u64(2),
    ];
    let mut res = [U256::ZERO; 6];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 5);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64s(&[
                1129392494308748068,
                9788068284009149837,
                4894034142004574918,
                11670389107857063267,
            ]),
            U256::from_u64s(&[
                1505856659078330757,
                752928329539165372,
                376464164769582686,
                9411604119239567151,
            ]),
            U256::from_u64s(&[
                4141105812465409564,
                11293924943087480581,
                5646962471543740290,
                12046853272626645953,
            ]),
            U256::from_u64s(&[
                13552709931704976706,
                6776354965852488348,
                3388177482926244174,
                10917460778317897895,
            ]),
            U256::from_u64(4),
        ]
    );

    // [108509871213644914495224788117262720812102234692915980461799068728781566717980, 97610657482852136417037764955262109743864410230427530868747251158690618238750, 3]
    let a = [
        U256::from_u64s(&[
            3518787499274874908,
            11923926198416169974,
            1820857286742675440,
            17286619810848184563,
        ]),
        U256::from_u64s(&[
            11839413834896467742,
            84512363519702235,
            1736344923222973205,
            15550274887625211358,
        ]),
        U256::from_u64(3),
    ];
    let mut res = [U256::ZERO; 10];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 5);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64s(&[
                305311352864539408,
                5121716100336988427,
                13890375398671508018,
                13220740273570563432,
            ]),
            U256::from_u64s(&[
                10128952842933608604,
                16153313847886807076,
                15464981750310544624,
                678217237060349431,
            ]),
            U256::from_u64s(&[
                14322988078933886010,
                15646911644215079500,
                15147024421881662240,
                2422961878364395612,
            ]),
            U256::from_u64s(&[
                4563939620935117407,
                3421005181133378521,
                11628240122499389652,
                14176532194418598693,
            ]),
            U256::from_u64(14),
        ]
    );

    // [94296684984090328915786319894647341212298256830891608529662243544763352873524, 85801804490443701075961240310880668636621463408258506144468684495763969931231]
    let a = [
        U256::from_u64s(&[
            6182623793237064244,
            12219027776554098351,
            2741896438568350391,
            15022328609475927733,
        ]),
        U256::from_u64s(&[
            355608786200688607,
            3036869909053710916,
            5463799565519852727,
            13669016069429398136,
        ]),
    ];
    let mut res = [U256::ZERO; 4];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 4);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64s(&[
                2203846575238781584,
                2353650844004517578,
                17883692277342340788,
                8997264183554908483,
            ]),
            U256::from_u64s(&[
                1897748063176306984,
                7762514037481693647,
                11234989379536153012,
                2539286703409012886,
            ]),
            U256::from_u64s(&[
                10326883856433751031,
                9178229804528314967,
                7400071464983950585,
                11451957437237960827,
            ]),
            U256::from_u64s(&[
                8919148271095477363,
                8551504335501889726,
                2404371079668068617,
                10128725132182423352,
            ]),
        ]
    );

    // [MAX, (MAX+1)/2+1, MAX-1]
    // this covers the case where the addition 2·a_i·a_j + out[i + j] produces a third chunk carry
    let a = [U256::MAX, U256_MAX_HALF_PLUS_ONE, U256_MAX_MINUS_ONE];
    let mut res = [U256::ZERO; 6];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 6);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64(1),
            U256::from_u64s(&[
                18446744073709551612,
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
            ]),
            U256::from_u64(6),
            U256::from_u64s(&[
                18446744073709551608,
                18446744073709551615,
                18446744073709551615,
                4611686018427387903,
            ]),
            U256::from_u64(6),
            U256::from_u64s(&[
                18446744073709551613,
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
            ]),
        ]
    );

    // [(MAX+1)/2+1, (MAX+1)/2+1, MAX-1]
    // this covers the case where out[i + j] has a non-zero second chunk (i.e., when j == len -1)
    // and it produces carry when added to the second chunk of 2·a_i·a_j
    let a = [U256_MAX_HALF_PLUS_ONE, U256_MAX_HALF_PLUS_ONE, U256_MAX_MINUS_ONE];
    let mut res = [U256::ZERO; 6];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 6);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64(1),
            U256::from_u64s(&[3, 0, 0, 4611686018427387904,]),
            U256::from_u64s(&[
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
                9223372036854775807,
            ]),
            U256::from_u64s(&[
                18446744073709551613,
                18446744073709551615,
                18446744073709551615,
                4611686018427387903,
            ]),
            U256::from_u64(5),
            U256::from_u64s(&[
                18446744073709551613,
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
            ]),
        ]
    );

    // [(MAX+1)/2+1, MAX, MAX-1]
    // this covers the case where carry has a non-zero second chunk
    // and it produces carry when added to the second chunk of 2·a_i·a_j + out[i + j]
    let a = [U256_MAX_HALF_PLUS_ONE, U256::MAX, U256_MAX_MINUS_ONE];
    let mut res = [U256::ZERO; 6];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 6);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64(1),
            U256::from_u64s(&[
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
                4611686018427387903,
            ]),
            U256::from_u64s(&[
                18446744073709551614,
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
            ]),
            U256::from_u64(2),
            U256::from_u64(0),
            U256::from_u64s(&[
                18446744073709551614,
                18446744073709551615,
                18446744073709551615,
                18446744073709551615,
            ]),
        ]
    );

    // edge case found
    let a = [
        U256::from_u64s(&[
            12192428590012910465,
            10325414821621504851,
            8140810102968118826,
            6041678310627744092,
        ]),
        U256::from_u64s(&[
            11473326399435064760,
            14629889290029532817,
            14712733133741508414,
            10869754502426216518,
        ]),
        U256::from_u64s(&[
            16902147543735613040,
            1346689612153720003,
            13327627970660280174,
            2985330084546286518,
        ]),
        U256::from_u64s(&[
            3206707944606186389,
            4162506302465925006,
            12638699149420037214,
            16667835708431325483,
        ]),
        U256::from_u64s(&[
            524431235559465255,
            13183863742287294289,
            13806698630233970602,
            8215224952463146586,
        ]),
        U256::from_u64s(&[
            18408381768065083351,
            3227942385989251222,
            11499103209115886326,
            5795083679297594270,
        ]),
        U256::from_u64s(&[
            15535364391754013976,
            529445594625289359,
            17816560071936180898,
            7092842689162544712,
        ]),
        U256::from_u64s(&[
            18031030420675048403,
            11817951687670528554,
            14428393994711635475,
            3874120753930835095,
        ]),
        U256::from_u64s(&[
            17949754746527552080,
            3292199419316794632,
            2107224440144676518,
            14728869274945569269,
        ]),
        U256::from_u64s(&[
            3792710572413410109,
            6291721506883544697,
            875467982779226050,
            14103375801187148732,
        ]),
        U256::from_u64s(&[
            10502834390998100452,
            9907019632295354106,
            9090917681269628022,
            16780600197363339133,
        ]),
        U256::from_u64s(&[
            10259481823121181171,
            13073120278769955218,
            5378998344396164424,
            10335347883266659959,
        ]),
        U256::from_u64s(&[
            14907102954822386277,
            9881574209373892824,
            12734809559496576722,
            14533123423362193756,
        ]),
        U256::from_u64s(&[
            17398340187512952642,
            17229365779470585754,
            7583434972403709792,
            14393353878987946134,
        ]),
        U256::from_u64s(&[
            17560978627224532192,
            16340035414426933823,
            10484021086329963527,
            7366714123086800953,
        ]),
        U256::from_u64s(&[
            17500044754666574496,
            362907128360934851,
            15457982614814095210,
            15795479471708216334,
        ]),
    ];
    let mut res = [U256::ZERO; 32];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 32);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64s(&[
                15931756936355567361,
                16037485531010765147,
                17481208833756204857,
                8086402348308853394
            ]),
            U256::from_u64s(&[
                8769104656209159423,
                4681665228903057527,
                14799454737592100429,
                3077188296226398719
            ]),
            U256::from_u64s(&[
                10141983830874837408,
                8064379874801831376,
                14015905591975866328,
                17485856700889870095
            ]),
            U256::from_u64s(&[
                17619490140744737481,
                15073269066933740814,
                13749414758281318299,
                8589507877445663742
            ]),
            U256::from_u64s(&[
                2882388458483338735,
                9329949526448721485,
                15072897741257455872,
                8257862864739344375
            ]),
            U256::from_u64s(&[
                9066042642452224783,
                5389875743024141911,
                3630301363721889091,
                5036938911183382996
            ]),
            U256::from_u64s(&[
                10572445776035737731,
                13966410927620323094,
                17304093883531990632,
                18194936138197449249
            ]),
            U256::from_u64s(&[
                3931132775381145770,
                11647169008993916819,
                13102873199824937109,
                11657490003206983403
            ]),
            U256::from_u64s(&[
                4945181414181316008,
                2577330184090756962,
                13587934904278314075,
                13394263865150582253
            ]),
            U256::from_u64s(&[
                7679723654065659033,
                11709368926401757479,
                4517108107332522194,
                415529025747358859
            ]),
            U256::from_u64s(&[
                3571692877005265985,
                2339610710482145149,
                8012371059244910074,
                2256634975819829440
            ]),
            U256::from_u64s(&[
                18092637289646722981,
                1668794510853624033,
                7326932857512143785,
                17052102769282302642
            ]),
            U256::from_u64s(&[
                2038518696445305690,
                1263304098444449829,
                17888162767190994314,
                10384627673612934626
            ]),
            U256::from_u64s(&[
                8925550873244181880,
                14881075439577857955,
                13522426472574514697,
                4299442093223197402
            ]),
            U256::from_u64s(&[
                13595601011595947290,
                2317619590343442464,
                4569700880330833546,
                15554384176867623830
            ]),
            U256::from_u64s(&[
                12277062958603955183,
                12128113712302536334,
                2975010596599514197,
                15436681276439120918
            ]),
            U256::from_u64s(&[
                8269920735812964189,
                4949123871151335760,
                15915572590658795160,
                13545545443112263312
            ]),
            U256::from_u64s(&[
                12975725247972395288,
                5321855472093164841,
                9558047604257627625,
                7731577880954166377
            ]),
            U256::from_u64s(&[
                15980686769676086375,
                8742588037999645039,
                12777353499557188944,
                12779323065520569149
            ]),
            U256::from_u64s(&[
                10548810656291540251,
                13598011908428749377,
                14084388610827015255,
                3512338119944062669
            ]),
            U256::from_u64s(&[
                10465941532438787317,
                5508916097568385377,
                4252259624788608877,
                14329449449262617886
            ]),
            U256::from_u64s(&[
                16381920023811258305,
                18082249794077064944,
                12000543659206406236,
                12457876652560361025
            ]),
            U256::from_u64s(&[
                7714824882393173714,
                3917376226952731667,
                2391133290851201167,
                15262491826904676399
            ]),
            U256::from_u64s(&[
                18337699179318526814,
                11178268645975139854,
                5438675389928405457,
                500882139858018583
            ]),
            U256::from_u64s(&[
                15886125912453315006,
                17098736473550689483,
                5790275803326664804,
                2451899722294078192
            ]),
            U256::from_u64s(&[
                6723031235155814664,
                9065801232654233793,
                626051242367302764,
                578946906426419751
            ]),
            U256::from_u64s(&[
                9892167377355496547,
                6314751537016506306,
                8154665412996708083,
                6012537335815451266
            ]),
            U256::from_u64s(&[
                17512050245670511388,
                15913969152110764124,
                3037404315964812982,
                9451775036341587138
            ]),
            U256::from_u64s(&[
                17647840564096962394,
                9658982763931737854,
                14633352629993477899,
                12756916945502507403
            ]),
            U256::from_u64s(&[
                5101001849599453799,
                11075938779813494578,
                13407251536920005097,
                7781323257161345756
            ]),
            U256::from_u64s(&[
                10784886213717042092,
                6908199334545577823,
                11911010325278948955,
                4309970113159479149
            ]),
            U256::from_u64s(&[
                5950064995335528756,
                8042297992203788226,
                6065835536715061237,
                13525268781537499280
            ]),
        ]
    );

    let a = [
        U256::from_u64s(&[8411135428537101944, 14747506717619788, 0, 0]),
        U256::from_u64s(&[
            17084313400885090581,
            2121020303797364812,
            6448461645324402335,
            13043817825332782212,
        ]),
        U256::from_u64s(&[4790811567723628071, 2833133123455345538, 518, 0]),
    ];
    let mut res = [U256::ZERO; 20];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 6);
    assert_eq!(
        &res[..len_res],
        [
            U256::from_u64s(&[
                6731328198429071424,
                3791622267930317728,
                2803721189398460494,
                11790099841858,
            ]),
            U256::from_u64s(&[
                10883423227325124528,
                2162574754803282913,
                6680303173730777343,
                17095418603806698732,
            ]),
            U256::from_u64s(&[
                11413303354290198953,
                306156034004202361,
                17436197252843352630,
                7641473467499587275,
            ]),
            U256::from_u64s(&[
                14352287128226570342,
                18158050477660294464,
                16650386693900523796,
                17392956307603920229,
            ]),
            U256::from_u64s(&[
                18309075972401747581,
                12285213232984107529,
                3171862288691316054,
                2528733384841448744,
            ]),
            U256::from_u64(268483),
        ]
    );

    // [0]*9 || [MAX]
    let mut a = vec![U256::ZERO; 9];
    a.push(U256::MAX);
    let mut res = vec![U256::ZERO; 20];
    let len_res = square_long(&a, &mut res);
    assert_eq!(len_res, 20);
    let mut res_expected = vec![U256::ZERO; 20];
    res_expected[18] = U256::ONE;
    res_expected[19] = U256_MAX_MINUS_ONE;
    assert_eq!(&res[..len_res], &res_expected);

    println!("Square tests passed");
}
